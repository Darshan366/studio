rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to swipe data.
     * @path /swipes/{swipeId}
     * @allow create: (auth != null) - Allows any authenticated user to create a swipe.
     * @deny get: if false; -  Swipes should not be individually accessible outside of the matching process.
     * @deny list: if false; -  Listing swipes should be denied to prevent unauthorized data access.
     * @deny update: if true; -  Swipes should not be updated after creation.
     * @deny delete: if true; -  Swipes cannot be deleted.
     * @principle Limits reads on swipes and prevents modifications.
     */
    match /swipes/{swipeId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to match data.
     * @path /matches/{matchId}
     * @allow get: if true; - Allows any user to get match data.
     * @allow list: if true; -  Allows any user to list match data.
     * @deny create: if false; -  Matches should only be created by a trusted backend.
     * @deny update: if true; -  Matches should not be updated after creation.
     * @deny delete: if true; -  Matches should not be deleted.
     * @principle Restricts match modification and deletion.
     */
    match /matches/{matchId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to conversation metadata.
     * @path /conversations/{conversationId}
     * @allow get: if isParticipant(resource.data.userAId, resource.data.userBId); - Allows participants to get conversation metadata.
     * @allow list: if false; -  Listing conversations is disallowed for privacy.
     * @deny create: if false; -  Conversations should only be created by a trusted backend.
     * @deny update: if !isExistingParticipant(resource.data.userAId, resource.data.userBId); - Prevents non-participants from updating conversation metadata.
     * @deny delete: if true; -  Conversations should not be deleted.
     * @principle Enforces participant-only access to conversation metadata.
     */
    match /conversations/{conversationId} {
      allow get: if exists(/databases/$(database)/documents/matches/{conversationId}) && isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to individual messages within a conversation.
     * @path /conversations/{conversationId}/messages/{messageId}
     * @allow get: if isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId); - Allows participants to read messages.
     * @allow list: if isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId); - Allows participants to list messages.
     * @allow create: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId) && request.auth.uid == request.resource.data.senderId; - Allows participants to create messages.
     * @deny update: if true; -  Messages should not be updated after creation.
     * @deny delete: if true; -  Messages should not be deleted.
     * @principle Enforces participant-only access to messages within a conversation.
     */
    match /conversations/{conversationId}/messages/{messageId} {
      allow get: if exists(/databases/$(database)/documents/matches/{conversationId}) && isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId);
      allow list: if false;
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/matches/{conversationId}) && isParticipant(get(/databases/$(database)/documents/matches/{conversationId}).data.userAId, get(/databases/$(database)/documents/matches/{conversationId}).data.userBId) && request.auth.uid == request.resource.data.senderId;
      allow update: if false;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isParticipant(userAId, userBId) {
        return isSignedIn() && (request.auth.uid == userAId || request.auth.uid == userBId);
    }

    function isExistingParticipant(userAId, userBId) {
        return resource.data != null && isSignedIn() && (request.auth.uid == userAId || request.auth.uid == userBId);
    }
  }
}