
/**
 * @fileoverview Firestore Security Rules for the FitConnect app.
 *
 * Core Philosophy:
 * This ruleset prioritizes public data access while maintaining strict authorization for write operations.
 *
 * Data Structure:
 * - /users/{userId}: Public user profile information.
 * - /users/{userId}/progress/metrics: User's private, editable progress data.
 * - /swipes/{swipeId}: Stores individual swipe actions.
 * - /matches/{matchId}: Stores mutual matches.
 * - /conversations/{matchId}: Stores conversation metadata.
 * - /conversations/{matchId}/messages/{messageId}: Sub-collection for messages within a conversation.
 * - /notifications/{userId}/user_notifications/{notificationId}: Stores notifications for a user.
 *
 * Key Security Decisions:
 * - Public read access to user profiles, matches, and conversations.
 * - Owner-only write access to user profiles, progress metrics, swipes and notifications.
 * - Participants-only write access to conversations and messages.
 * - Server-side creation of matches.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read user profiles, but only the owner to modify their own profile.
     * @path /users/{userId}
     * @allow (get, list): Any user can read any profile.
     * @allow (create, update, delete): Only the user with the matching UID can modify their profile.
     * @deny (create, update, delete): Any other user attempting to modify this profile.
     * @principle Allows public read access while enforcing owner-only writes.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && resource != null;
      allow delete: if request.auth.uid == userId && resource != null;
        
      /**
       * @description Rules for user's editable progress metrics.
       * @path /users/{userId}/progress/metrics
       * @allow (get, create, update): Only the owner can read or write their own progress.
       * @deny (list, delete): Listing or deleting the metrics document is not allowed.
       */
      match /progress/metrics {
        allow get, create, update: if request.auth.uid == userId;
        allow list, delete: if false;
      }
    }

    /**
     * @description Allows anyone to read swipes, but only the owner to create their own swipes.
     * @path /swipes/{swipeId}
     * @allow (get, list): Any user can read any swipe.
     * @allow (create): Only the user with the matching swiperId can create a swipe.
     * @deny (update, delete): No one can update or delete swipes.
     * @principle Allows public read access while enforcing owner-only creation.
     */
    match /swipes/{swipeId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.swiperId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read matches, and allows authenticated users to create a match if they are part of it.
     * @path /matches/{matchId}
     * @allow (get, list): Any user can read any match.
     * @allow (create): A user can create a match if their UID is in the `users` array.
     * @deny (update, delete): No one can update or delete matches.
     * @principle Allows public read access while ensuring only participants can create a match.
     */
    match /matches/{matchId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.auth.uid in request.resource.data.users;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read conversations, and only participants to create, update, or delete them.
     * @path /conversations/{matchId}
     * @allow (get, list): Any user can read any conversation.
     * @allow (create, update, delete): Only participants can create, update, or delete conversations.
     * @principle Allows public read access while enforcing participant-only writes.
     */
    match /conversations/{matchId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.users.hasAny([request.auth.uid]);
      allow update: if request.resource.data.users.hasAny([request.auth.uid]) && resource != null;
      allow delete: if request.resource.data.users.hasAny([request.auth.uid]) && resource != null;
    }

    /**
     * @description Allows anyone to read messages, and only participants to create, update, or delete them.
     * @path /conversations/{matchId}/messages/{messageId}
     * @allow (get, list): Any user can read any message.
     * @allow (create, update, delete): Only participants can create, update, or delete messages.
     * @principle Allows public read access while enforcing participant-only writes.
     */
    match /conversations/{matchId}/messages/{messageId} {
      allow get: if true;
      allow list: if true;
      allow create: if get(/databases/$(database)/documents/conversations/$(matchId)).data.users.hasAny([request.auth.uid]);
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description Rules for user notifications.
     * @path /notifications/{userId}/user_notifications/{notificationId}
     * @allow (list, get, update): Only the owner can read or update their notifications.
     * @allow (create): Any authenticated user can create a notification (e.g., a match).
     * @deny (delete): No one can delete notifications.
     */
    match /notifications/{userId}/user_notifications/{notificationId} {
      allow list, get, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow delete: if false;
    }
  }
}

    