/**
 * @fileoverview Firestore Security Rules for the FitConnect app.
 *
 * Core Philosophy:
 * This ruleset prioritizes public data access while maintaining strict authorization for write operations.
 *
 * Data Structure:
 * - /users/{userId}: Public user profile information.
 * - /swipes/{swipeId}: Stores individual swipe actions.
 * - /matches/{matchId}: Stores mutual matches.
 * - /conversations/{matchId}: Stores conversation metadata.
 * - /conversations/{matchId}/messages/{messageId}: Sub-collection for messages within a conversation.
 *
 * Key Security Decisions:
 * - Public read access to user profiles, matches, and conversations.
 * - Owner-only write access to user profiles and swipes.
 * - Participants-only write access to conversations and messages.
 * - Server-side creation of matches.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read user profiles, but only the owner to modify their own profile.
     * @path /users/{userId}
     * @allow (get, list): Any user can read any profile.
     * @allow (create, update, delete): Only the user with the matching UID can modify their profile.
     * @deny (create, update, delete): Any other user attempting to modify this profile.
     * @principle Allows public read access while enforcing owner-only writes.
     */
    match /users/{userId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && resource != null;
      allow delete: if request.auth.uid == userId && resource != null;
    }

    /**
     * @description Allows anyone to read swipes, but only the owner to create their own swipes.
     * @path /swipes/{swipeId}
     * @allow (get, list): Any user can read any swipe.
     * @allow (create): Only the user with the matching swiperId can create a swipe.
     * @deny (update, delete): No one can update or delete swipes.
     * @principle Allows public read access while enforcing owner-only creation.
     */
    match /swipes/{swipeId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.swiperId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read matches, but no one can create, update, or delete them (server-managed).
     * @path /matches/{matchId}
     * @allow (get, list): Any user can read any match.
     * @deny (create, update, delete): No one can create, update, or delete matches (server-managed).
     * @principle Allows public read access with server-only writes.
     */
    match /matches/{matchId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read conversations, and only participants to create, update, or delete them.
     * @path /conversations/{matchId}
     * @allow (get, list): Any user can read any conversation.
     * @allow (create, update, delete): Only participants can create, update, or delete conversations.
     * @principle Allows public read access while enforcing participant-only writes.
     */
    match /conversations/{matchId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.users.hasAny([request.auth.uid]);
      allow update: if request.resource.data.users.hasAny([request.auth.uid]) && resource != null;
      allow delete: if request.resource.data.users.hasAny([request.auth.uid]) && resource != null;
    }

    /**
     * @description Allows anyone to read messages, and only participants to create, update, or delete them.
     * @path /conversations/{matchId}/messages/{messageId}
     * @allow (get, list): Any user can read any message.
     * @allow (create, update, delete): Only participants can create, update, or delete messages.
     * @principle Allows public read access while enforcing participant-only writes.
     */
    match /conversations/{matchId}/messages/{messageId} {
      allow get: if true;
      allow list: if true;
      allow create: if get(/databases/$(database)/documents/conversations/$(matchId)).data.users.hasAny([request.auth.uid]);
      allow update: if false;
      allow delete: if false;
    }
  }
}